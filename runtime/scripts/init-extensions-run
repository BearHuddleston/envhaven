#!/usr/bin/with-contenv bash

# Install VS Code extensions
# Note: code-server binary is at /app/code-server/bin/code-server
# We must use full path as it's not in PATH during s6 init
#
# IMPORTANT: linuxserver/code-server uses --extensions-dir /config/extensions
# so we must install extensions there, not the default ~/.local/share/code-server/extensions
#
# The EnvHaven extension is pre-installed at build time to /app/pre-installed-extensions
# and is symlinked here at runtime to survive volume mounts.

EXTENSIONS_INSTALLED="/config/.extensions-installed"
EXTENSIONS_DIR="/config/extensions"
PRE_INSTALLED_DIR="/app/pre-installed-extensions"
CODE_SERVER="/app/code-server/bin/code-server"

# Wait for code-server binary to exist (should already be there from base image)
if [ ! -x "$CODE_SERVER" ]; then
    echo "WARNING: code-server binary not found at $CODE_SERVER"
    # Try alternate location
    CODE_SERVER=$(which code-server 2>/dev/null || find /app -name code-server -type f -executable 2>/dev/null | head -1)
    if [ -z "$CODE_SERVER" ]; then
        echo "ERROR: Cannot find code-server binary"
        exit 0  # Don't fail the container startup
    fi
fi

echo "Using code-server at: $CODE_SERVER"
echo "Installing extensions to: $EXTENSIONS_DIR"

# Ensure extensions directory exists
mkdir -p "$EXTENSIONS_DIR"

# ----------------------------------------
# Link pre-installed extensions (built into image)
# These are in /app/pre-installed-extensions and need to be
# symlinked to /config/extensions at runtime
# ----------------------------------------
if [ -d "$PRE_INSTALLED_DIR" ]; then
    echo "Linking pre-installed extensions from $PRE_INSTALLED_DIR..."
    for ext in "$PRE_INSTALLED_DIR"/*; do
        if [ -d "$ext" ]; then
            extname=$(basename "$ext")
            target="$EXTENSIONS_DIR/$extname"
            if [ ! -e "$target" ]; then
                ln -sf "$ext" "$target"
                echo "Linked: $extname"
            else
                echo "Skipping $extname (already exists)"
            fi
        fi
    done
fi

# Helper function to install extension to the correct directory
install_ext() {
    "$CODE_SERVER" --extensions-dir "$EXTENSIONS_DIR" --install-extension "$1"
}

if [ ! -f "$EXTENSIONS_INSTALLED" ]; then
    echo "Installing VS Code extensions from Open VSX..."
    
    # GitHub Theme - REQUIRED for dark mode
    install_ext GitHub.github-vscode-theme
    
    # Fix ownership (extensions may have been installed as root)
    chown -R abc:abc "$EXTENSIONS_DIR" 2>/dev/null || true
    
    # Mark as installed
    touch "$EXTENSIONS_INSTALLED"
    echo "Extensions installed successfully to $EXTENSIONS_DIR"
else
    echo "Extensions already installed, skipping"
fi

# Always ensure EnvHaven extension is linked (even after first run)
# This handles image updates where the extension may have changed
if [ -d "$PRE_INSTALLED_DIR" ]; then
    for ext in "$PRE_INSTALLED_DIR"/envhaven.*; do
        if [ -d "$ext" ]; then
            extname=$(basename "$ext")
            target="$EXTENSIONS_DIR/$extname"
            # Force re-link EnvHaven extension to get updates
            ln -sf "$ext" "$target"
            echo "EnvHaven extension linked: $extname"
        fi
    done
fi
